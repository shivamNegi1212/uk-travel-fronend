# ğŸ”„ Complete Request Flow Diagram

## Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          FRONTEND (React)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. Axios Interceptor (src/services/api.js)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ request.use((config) => {                                        â”‚       â”‚
â”‚  â”‚   const token = localStorage.getItem('token')                    â”‚       â”‚
â”‚  â”‚   if (token) {                                                   â”‚       â”‚
â”‚  â”‚     config.headers.Authorization = `Bearer ${token}` âœ…          â”‚       â”‚
â”‚  â”‚   }                                                              â”‚       â”‚
â”‚  â”‚   return config                                                  â”‚       â”‚
â”‚  â”‚ })                                                               â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                 â†“                                            â”‚
â”‚  2. HTTP Request (With or Without Token)                                     â”‚
â”‚                                 â†“                                            â”‚
â”‚  POST /api/ride-requests                                                     â”‚
â”‚  GET /api/ride-requests/passenger/my-bookings                               â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“ HTTP
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BACKEND (Express + MongoDB)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  3. Express Router (backend/src/routes/rideRequestRoutes.js)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  POST /          â†’ createRequest (PUBLIC - no auth needed)      â”‚       â”‚
â”‚  â”‚  GET /passenger/my-bookings â†’ getPassengerBookings (PROTECTED)  â”‚       â”‚
â”‚  â”‚  GET /passenger/my-requests â†’ getPassengerRequests (PROTECTED)  â”‚       â”‚
â”‚  â”‚  PUT /:id/accept â†’ acceptRequest (PROTECTED + driver check)     â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                 â†“                                            â”‚
â”‚  4. Optional Auth Middleware (backend/src/middleware/auth.js)               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ IF route has protect middleware:                                â”‚       â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚       â”‚
â”‚  â”‚   â”‚ 1. Extract token from Authorization header             â”‚   â”‚       â”‚
â”‚  â”‚   â”‚ 2. Verify JWT signature                                â”‚   â”‚       â”‚
â”‚  â”‚   â”‚ 3. Decode: { id, role } = jwt.verify(token)           â”‚   â”‚       â”‚
â”‚  â”‚   â”‚ 4. Query DB: user = Passenger.findById(id)            â”‚   â”‚       â”‚
â”‚  â”‚   â”‚ 5. Attach: req.user = user                            â”‚   â”‚       â”‚
â”‚  â”‚   â”‚ 6. Continue: next()                                    â”‚   â”‚       â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚       â”‚
â”‚  â”‚ ELSE (no protect):                                              â”‚       â”‚
â”‚  â”‚   req.user = undefined                                         â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                 â†“                                            â”‚
â”‚  5. Controller (backend/src/controllers/rideRequestController.js)           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚                                                                  â”‚       â”‚
â”‚  â”‚  SCENARIO A: Guest Booking (POST /api/ride-requests)           â”‚       â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚       â”‚
â”‚  â”‚  req.user = undefined                                           â”‚       â”‚
â”‚  â”‚  passengerId = req.user ? req.user._id : null  â†’ null          â”‚       â”‚
â”‚  â”‚                                                                  â”‚       â”‚
â”‚  â”‚  Create RideRequest {                                           â”‚       â”‚
â”‚  â”‚    passengerId: null          âœ… Now allowed (required: false)  â”‚       â”‚
â”‚  â”‚    rideId/vehicleId: "xyz",                                     â”‚       â”‚
â”‚  â”‚    driverId: "driver123",                                       â”‚       â”‚
â”‚  â”‚    passengerName: "Raj",      âœ… Comes from request body        â”‚       â”‚
â”‚  â”‚    passengerPhone: "9876543210",                                â”‚       â”‚
â”‚  â”‚    requestedSeats: 2,                                           â”‚       â”‚
â”‚  â”‚    status: 'pending'                                            â”‚       â”‚
â”‚  â”‚  }                                                              â”‚       â”‚
â”‚  â”‚                                                                  â”‚       â”‚
â”‚  â”‚  SCENARIO B: Registered Booking (POST /api/ride-requests)      â”‚       â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚       â”‚
â”‚  â”‚  Authorization: Bearer <token>                                  â”‚       â”‚
â”‚  â”‚  req.user = { _id: "user123", name: "Priya", ... }            â”‚       â”‚
â”‚  â”‚  passengerId = req.user._id  â†’ "user123"                       â”‚       â”‚
â”‚  â”‚                                                                  â”‚       â”‚
â”‚  â”‚  Create RideRequest {                                           â”‚       â”‚
â”‚  â”‚    passengerId: "user123",    âœ… From JWT token               â”‚       â”‚
â”‚  â”‚    ...rest same                                                 â”‚       â”‚
â”‚  â”‚  }                                                              â”‚       â”‚
â”‚  â”‚                                                                  â”‚       â”‚
â”‚  â”‚  SCENARIO C: Get My Bookings (GET /passenger/my-bookings)      â”‚       â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚       â”‚
â”‚  â”‚  Authorization: Bearer <token>  (REQUIRED)                      â”‚       â”‚
â”‚  â”‚  req.user = { _id: "user123", ... }                            â”‚       â”‚
â”‚  â”‚                                                                  â”‚       â”‚
â”‚  â”‚  Query: RideRequest.find({ passengerId: "user123" })          â”‚       â”‚
â”‚  â”‚  Result: Returns [booking1, booking2, ...]                     â”‚       â”‚
â”‚  â”‚                                                                  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                 â†“                                            â”‚
â”‚  6. MongoDB (RideRequest Schema)                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ rideRequestSchema = {                                            â”‚       â”‚
â”‚  â”‚   passengerId: {                                                â”‚       â”‚
â”‚  â”‚     type: ObjectId,                                            â”‚       â”‚
â”‚  â”‚     ref: 'Passenger',                                          â”‚       â”‚
â”‚  â”‚     required: false,      âœ… NOW OPTIONAL!                     â”‚       â”‚
â”‚  â”‚     default: null                                              â”‚       â”‚
â”‚  â”‚   },                                                           â”‚       â”‚
â”‚  â”‚   rideId: { type: ObjectId, required: true },                 â”‚       â”‚
â”‚  â”‚   driverId: { type: ObjectId, required: true },               â”‚       â”‚
â”‚  â”‚   passengerName: { type: String, required: true },            â”‚       â”‚
â”‚  â”‚   passengerPhone: { type: String, required: true },           â”‚       â”‚
â”‚  â”‚   requestedSeats: { type: Number, required: true },           â”‚       â”‚
â”‚  â”‚   totalPrice: { type: Number, required: true },               â”‚       â”‚
â”‚  â”‚   status: { enum: ['pending', 'accepted', ...] },             â”‚       â”‚
â”‚  â”‚   createdAt: { type: Date, default: Date.now }                â”‚       â”‚
â”‚  â”‚ }                                                              â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚ âœ… Guest booking with passengerId=null â†’ SAVES OK              â”‚       â”‚
â”‚  â”‚ âœ… Registered booking with passengerId=id â†’ SAVES OK           â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                 â†“                                            â”‚
â”‚  7. Response                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚  Success (201): {                                               â”‚       â”‚
â”‚  â”‚    success: true,                                              â”‚       â”‚
â”‚  â”‚    message: 'Booking request created',                         â”‚       â”‚
â”‚  â”‚    bookingRequest: { _id, passengerId, ... }                   â”‚       â”‚
â”‚  â”‚  }                                                             â”‚       â”‚
â”‚  â”‚                                                                 â”‚       â”‚
â”‚  â”‚  OR Error (400): {                                             â”‚       â”‚
â”‚  â”‚    success: false,                                             â”‚       â”‚
â”‚  â”‚    message: 'Detailed error message'                           â”‚       â”‚
â”‚  â”‚  }                                                             â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â†“ JSON Response
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FRONTEND RECEIVES RESPONSE                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  React State Update                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ try {                                                            â”‚       â”‚
â”‚  â”‚   const response = await api.post('/ride-requests', {          â”‚       â”‚
â”‚  â”‚     vehicleId: "xyz",                                          â”‚       â”‚
â”‚  â”‚     passengerName: "Raj",                                      â”‚       â”‚
â”‚  â”‚     passengerPhone: "9876543210",                              â”‚       â”‚
â”‚  â”‚     requestedSeats: 2                                          â”‚       â”‚
â”‚  â”‚     // Token sent automatically! âœ…                             â”‚       â”‚
â”‚  â”‚   })                                                           â”‚       â”‚
â”‚  â”‚   showSuccessToast('Booking created!')                         â”‚       â”‚
â”‚  â”‚ } catch (error) {                                              â”‚       â”‚
â”‚  â”‚   showErrorToast(error.response.data.message)                 â”‚       â”‚
â”‚  â”‚   // Clear error handling âœ…                                   â”‚       â”‚
â”‚  â”‚ }                                                              â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Authentication Decision Tree

```
                    Request to /api/ride-requests
                             â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Has Bearer token?  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      /               \
                   YES                NO
                   â†“                  â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Verify JWT Token    â”‚   â”‚ Guest Booking    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Decode: {id, role}  â”‚   â”‚ passengerId=null â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“                          â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Load user from DB   â”‚   â”‚ Use name+phone   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ from request     â”‚
               â†“                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â†“
        â”‚ req.user = user     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ passengerId = id    â”‚   â”‚ Create booking   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ with null ID     â”‚
               â†“                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â†“
        â”‚ Create booking      â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ with user ID        â”‚   â”‚ âœ… Success (201) â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ âœ… Success (201)    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ Key Fixes at a Glance

### âŒ BEFORE (Broken)
```
1. POST /ride-requests â†’ passengerId required but set to null
   â†’ 400 Bad Request âŒ

2. GET /ride-requests/passenger/my-bookings â†’ Route not found
   â†’ 404 Not Found âŒ

3. Token sent but nowhere to attach it
   â†’ 401 Unauthorized âŒ
```

### âœ… AFTER (Working)
```
1. POST /ride-requests â†’ passengerId optional (false)
   â†’ 201 Created âœ…

2. GET /ride-requests/passenger/my-bookings â†’ Route registered
   â†’ 200 OK with bookings âœ…

3. Token sent via Axios interceptor
   â†’ 200 OK authenticated âœ…
```

---

## ğŸ§ª Real-World Examples

### Example 1: Guest Books a Vehicle

```javascript
// FRONTEND
const response = await api.post('/api/ride-requests', {
  vehicleId: '694add4d3d80067237320e49',
  passengerName: 'Raj Kumar',
  passengerPhone: '9876543210',
  requestedSeats: 2
})
// Token: NOT sent (guest)

// BACKEND
// req.user = undefined
// passengerId = null
// Saves: RideRequest { passengerId: null, ... } âœ…

// RESPONSE
{
  success: true,
  bookingRequest: {
    _id: '507f1f77bcf86cd799439011',
    passengerId: null,  // âœ… Allowed now
    vehicleId: '694add4d3d80067237320e49',
    passengerName: 'Raj Kumar',
    passengerPhone: '9876543210',
    requestedSeats: 2,
    status: 'pending'
  }
}
```

### Example 2: Registered User Checks Bookings

```javascript
// FRONTEND
const response = await api.get('/api/ride-requests/passenger/my-bookings')
// Token: SENT automatically via interceptor âœ…

// BACKEND
// Authorization: Bearer eyJhbGciOiJIUzI1NiIs...
// JWT decoded: { id: 'user_123', role: 'passenger' }
// req.user = Passenger { _id: 'user_123', name: 'Priya', ... }
// Query: RideRequest.find({ passengerId: 'user_123' })

// RESPONSE
{
  success: true,
  bookings: [
    {
      _id: '507f1f77bcf86cd799439011',
      passengerId: 'user_123',
      vehicleId: '694add4d3d80067237320e49',
      passengerName: 'Priya Singh',
      passengerPhone: '9876543210',
      status: 'accepted',
      createdAt: '2025-12-24T18:21:00.000Z'
    }
  ]
}
```

---

## ğŸ”’ Security Notes

âœ… **Public Routes** (no auth):
- `POST /api/ride-requests` - Anyone can book

âœ… **Protected Routes** (require auth):
- `GET /passenger/my-bookings` - Only owner can see
- `GET /driver/pending` - Only driver can see
- `PUT /:id/accept` - Only driver can accept

âœ… **Token Security**:
- Axios sends Authorization header automatically
- Backend verifies JWT signature
- Invalid/expired tokens return 401
- localStorage clears on logout

---

## ğŸ“ˆ Database Diagram

```
BEFORE (Broken):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RideRequest Collection                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                       â”‚
â”‚   _id: ObjectId,                        â”‚
â”‚   passengerId: ObjectId (REQUIRED),     â”‚
â”‚   ...                                   â”‚
â”‚ }                                       â”‚
â”‚                                         â”‚
â”‚ âŒ Cannot insert if passengerId = null  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

AFTER (Fixed):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RideRequest Collection                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ {                                       â”‚
â”‚   _id: ObjectId,                        â”‚
â”‚   passengerId: ObjectId | null (OPT),   â”‚
â”‚   ...                                   â”‚
â”‚ }                                       â”‚
â”‚                                         â”‚
â”‚ âœ… Can insert with passengerId = null   â”‚
â”‚ âœ… Can insert with passengerId = id     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ Learning Points

1. **Schema Design**: `required: true` blocks null values - use `required: false` for optional fields
2. **Middleware Order**: Specific routes before generic ones in Express
3. **Authentication**: Middleware can make `req.user` available to controllers
4. **Axios Interceptors**: Automatically add tokens without repeating code
5. **Guest vs Registered**: Same model with optional foreign keys

